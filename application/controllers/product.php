<?php if ( ! defined('BASEPATH')) exit('No direct script access allowed');class Product extends CI_Controller {	function __construct(){		parent::__construct();	}			function info(){		$this->session->set_userdata('productlogin', '');				$product_id = $this->input->get('product_id');		$product_key = $this->input->get('product_key');		$productinfo = $this->ProductModel->getproductinfo($product_id);		if(!empty($productinfo)){			if($productinfo['product_key'] == $product_key){				$data['productinfo'] = $productinfo;				$this->load->view('default/qrcode_product_login', $data);			}		}	}	function toactionstatus(){		$product_id = $this->input->get('product_id');		$product_key = $this->input->get('product_key');				$productlogin = $this->session->userdata('productlogin');		if($productlogin == ''){			redirect(base_url().'index.php/product/info?product_id='.$product_id.'&product_key='.$product_key);		}// 		echo 'product_id: '.$product_id.'<br /><br />';// 		echo 'product_key: '.$product_key.'<br />';		$productinfo = $this->ProductModel->getproductinfo($product_id);		if(!empty($productinfo)){			if($productinfo['product_key'] == $product_key){				$data['productinfo'] = $productinfo;								if($productinfo['step5_approve_status'] != '' && $productinfo['step5_approve_status'] == 1){					$this->load->view('default/qrcode_product_step6', $data);				}								else if($productinfo['step4_approve_status'] != '' && $productinfo['step4_approve_status'] == 1){					$this->load->view('default/qrcode_product_step5', $data);				}								else if($productinfo['step3_approve_status'] != '' && $productinfo['step3_approve_status'] == 1){					$this->load->view('default/qrcode_product_step4', $data);				}								else if($productinfo['step2_approve_status'] != '' && $productinfo['step2_approve_status'] == 1){					$this->load->view('default/qrcode_product_step3', $data);				}												else if($productinfo['step2_approve_status'] != '' && $productinfo['step2_approve_status'] == 0){					$this->load->view('default/qrcode_product_step2', $data);				}else if($productinfo['step1_approve_status'] != '' && $productinfo['step1_approve_status'] == 1){					$this->load->view('default/qrcode_product_step2', $data);				}								else{					$this->load->view('default/qrcode_product_step1', $data);				}			}		}	}		function tosubmitproduct_login($product_id = 0){		$password = $this->input->post('password');		if($password == 'rojo'){			$this->session->set_userdata('productlogin', $password);			echo 'yes';		}else{			echo 'no';		}	}			function tocheckusernumber(){		$user_number = $this->input->post('user_number');			$sql = "SELECT * FROM rojo_user_list WHERE user_number = '".$user_number."'";		$userinfo = $this->db->query($sql)->row_array();		if(!empty($userinfo)){			echo json_encode(array('status'=>'yes'));		}else{			echo json_encode(array('status'=>'no'));		}	}	function tosubmitproduct_step1($product_id = 0){		$user_number = $this->input->post('user_number');		$factory_id = $this->input->post('factory_id');		$date_cloth_due = $this->input->post('date_cloth_due');		$date_cloth_submitted = $this->input->post('date_cloth_submitted');				$sql = "SELECT * FROM rojo_user_list WHERE user_number = '".$user_number."'";		$userinfo = $this->db->query($sql)->row_array();		if(!empty($userinfo)){			$sql = "SELECT * FROM ".DB_PRE()."product_step1 WHERE product_id = ".$product_id;			$result = $this->db->query($sql)->row_array();			if(!empty($result)){				$step1_id = $result['step1_id'];				$this->db->update(DB_PRE().'product_step1', array('uid'=>$userinfo['uid'], 'factory_id'=>$factory_id, 'product_id'=>$product_id, 'step1_user_number'=>$user_number, 'step1_date_cloth_due'=>$date_cloth_due, 'step1_date_cloth_submitted'=>$date_cloth_submitted, 'step1_approve_status'=>0, 'created'=>mktime(), 'edited'=>mktime()), array('step1_id'=>$result['step1_id']));							$sql = "UPDATE ".DB_PRE()."product_step1 SET step1_status_num = step1_status_num + 1 WHERE step1_id = ".$result['step1_id'];				$this->db->query($sql);								$sql = "SELECT * FROM ".DB_PRE()."product_step1 WHERE product_id = ".$product_id;				$result = $this->db->query($sql)->row_array();				// 				if($result['step1_status_num'] == 4){// 					$sql = "UPDATE ".DB_PRE()."product_step1 SET step1_approve_status = 1, step1_approve_time_4 = ".mktime()." WHERE step1_id = ".$result['step1_id'];// 					$this->db->query($sql);// 				}				if($result['step1_status_num'] == 3){					$sql = "UPDATE ".DB_PRE()."product_step1 SET step1_approve_status = 1, step1_approve_time_3 = ".mktime()." WHERE step1_id = ".$result['step1_id'];					$this->db->query($sql);										//添加日志 --- START					$logarr = array('log_type'=>'step_1_3', 'product_id'=>$product_id, 'target_id'=>$step1_id, 'created'=>mktime());					$this->db->insert(DB_PRE().'product_log', $logarr);					//添加日志 --- END				}else if($result['step1_status_num'] == 2){					$sql = "UPDATE ".DB_PRE()."product_step1 SET step1_approve_time_2 = ".mktime()." WHERE step1_id = ".$result['step1_id'];					$this->db->query($sql);										//添加日志 --- START					$logarr = array('log_type'=>'step_1_2', 'product_id'=>$product_id, 'target_id'=>$step1_id, 'created'=>mktime());					$this->db->insert(DB_PRE().'product_log', $logarr);					//添加日志 --- END				}			}else{				$this->db->insert(DB_PRE().'product_step1', array('uid'=>$userinfo['uid'], 'factory_id'=>$factory_id, 'product_id'=>$product_id, 'step1_status_num'=>1, 'step1_user_number'=>$user_number, 'step1_date_cloth_due'=>$date_cloth_due, 'step1_date_cloth_submitted'=>$date_cloth_submitted, 'step1_approve_status'=>0, 'step1_approve_time_1'=>mktime(), 'created'=>mktime(), 'edited'=>mktime()));				$step1_id = $this->db->insert_id();								//添加日志 --- START					$logarr = array('log_type'=>'step_1_1', 'product_id'=>$product_id, 'target_id'=>$step1_id, 'created'=>mktime());					$this->db->insert(DB_PRE().'product_log', $logarr);				//添加日志 --- END						}			echo 'yes';		}else{			echo 'no';		}	}	function tosubmitproduct_step1_other($product_id = 0){		$productinfo = $this->ProductModel->getproductinfo($product_id);		$sql = "SELECT * FROM ".DB_PRE()."product_step1 WHERE product_id = ".$product_id;		$result = $this->db->query($sql)->row_array();		if(!empty($result)){			$step1_id = $result['step1_id'];			$this->db->update(DB_PRE().'product_step1', array('edited'=>mktime()), array('step1_id'=>$result['step1_id']));							$sql = "UPDATE ".DB_PRE()."product_step1 SET step1_status_num = step1_status_num + 1 WHERE step1_id = ".$result['step1_id'];			$this->db->query($sql);				$sql = "SELECT * FROM ".DB_PRE()."product_step1 WHERE product_id = ".$product_id;			$result = $this->db->query($sql)->row_array();			// 			if($result['step1_status_num'] == 4){// 				$sql = "UPDATE ".DB_PRE()."product_step1 SET step1_approve_status = 1, step1_approve_time_4 = ".mktime()." WHERE step1_id = ".$result['step1_id'];// 				$this->db->query($sql);// 			}			if($result['step1_status_num'] == 3){				$sql = "UPDATE ".DB_PRE()."product_step1 SET step1_approve_status = 1, step1_approve_time_3 = ".mktime()." WHERE step1_id = ".$result['step1_id'];				$this->db->query($sql);								//添加日志 --- START				$logarr = array('log_type'=>'step_1_3', 'product_id'=>$product_id, 'target_id'=>$step1_id, 'created'=>mktime());				$this->db->insert(DB_PRE().'product_log', $logarr);				//添加日志 --- END			}else if($result['step1_status_num'] == 2){				$sql = "UPDATE ".DB_PRE()."product_step1 SET step1_approve_time_2 = ".mktime()." WHERE step1_id = ".$result['step1_id'];				$this->db->query($sql);								//添加日志 --- START				$logarr = array('log_type'=>'step_1_2', 'product_id'=>$product_id, 'target_id'=>$step1_id, 'created'=>mktime());				$this->db->insert(DB_PRE().'product_log', $logarr);				//添加日志 --- END			}		}		echo 'yes';	}					function tosubmitproduct_step2($product_id = 0){																										// 		$notes = $this->input->post('notes');		$notes = $this->input->post('notes');		$sql = "SELECT * FROM ".DB_PRE()."product_step2 WHERE product_id = ".$product_id;		$result = $this->db->query($sql)->row_array();		if(!empty($result)){			$step2_id = $result['step2_id'];			$this->db->update(DB_PRE().'product_step2', array('product_id'=>$product_id, 'step2_notes'=>$notes, 'step2_approve_status'=>1, 'step2_approve_time'=>mktime(), 'created'=>mktime(), 'edited'=>mktime()), array('step2_id'=>$result['step2_id']));			//添加日志 --- START				$logarr = array('log_type'=>'step_2_1', 'product_id'=>$product_id, 'target_id'=>$step2_id, 'created'=>mktime());				$this->db->insert(DB_PRE().'product_log', $logarr);			//添加日志 --- END		}else{			$this->db->insert(DB_PRE().'product_step2', array('product_id'=>$product_id, 'step2_notes'=>$notes, 'step2_approve_status'=>1, 'step2_approve_time'=>mktime(), 'created'=>mktime(), 'edited'=>mktime()));			$step2_id = $this->db->insert_id();			//添加日志 --- START				$logarr = array('log_type'=>'step_2_1', 'product_id'=>$product_id, 'target_id'=>$step2_id, 'created'=>mktime());				$this->db->insert(DB_PRE().'product_log', $logarr);			//添加日志 --- END		}			}	function tosubmitproduct_step3($product_id = 0){		$date_new_due = $this->input->post('date_new_due');				$sql = "SELECT * FROM ".DB_PRE()."product_step3 WHERE product_id = ".$product_id;		$result = $this->db->query($sql)->row_array();		if(!empty($result)){			$step3_id = $result['step3_id'];			$this->db->update(DB_PRE().'product_step3', array('product_id'=>$product_id, 'step3_date_new_due'=>$date_new_due, 'step3_approve_status'=>1, 'step3_approve_time'=>mktime(), 'created'=>mktime(), 'edited'=>mktime()), array('step3_id'=>$result['step3_id']));			//添加日志 --- START				$logarr = array('log_type'=>'step_3_1', 'product_id'=>$product_id, 'target_id'=>$step3_id, 'created'=>mktime());				$this->db->insert(DB_PRE().'product_log', $logarr);			//添加日志 --- END		}else{			$this->db->insert(DB_PRE().'product_step3', array('product_id'=>$product_id, 'step3_date_new_due'=>$date_new_due, 'step3_approve_status'=>1, 'step3_approve_time'=>mktime(), 'created'=>mktime(), 'edited'=>mktime()));			$step3_id = $this->db->insert_id();			//添加日志 --- START				$logarr = array('log_type'=>'step_3_1', 'product_id'=>$product_id, 'target_id'=>$step3_id, 'created'=>mktime());				$this->db->insert(DB_PRE().'product_log', $logarr);			//添加日志 --- END		}	}		function tosubmitproduct_step4($product_id = 0){		$sql = "SELECT * FROM ".DB_PRE()."product_step4 WHERE product_id = ".$product_id." AND isdel = 0";		$result = $this->db->query($sql)->row_array();		if(!empty($result)){			$step4_id = $result['step4_id'];			$this->db->update(DB_PRE().'product_step4', array('step4_approve_status'=>0, 'created'=>mktime(), 'edited'=>mktime()), array('step4_id'=>$result['step4_id']));					$sql = "UPDATE ".DB_PRE()."product_step4 SET step4_status_num = step4_status_num + 1 WHERE step4_id = ".$result['step4_id'];			$this->db->query($sql);						$sql = "SELECT * FROM ".DB_PRE()."product_step4 WHERE product_id = ".$product_id." AND isdel = 0";			$result = $this->db->query($sql)->row_array();						if($result['step4_status_num'] == 2){				$sql = "UPDATE ".DB_PRE()."product_step4 SET step4_approve_status = 1, step4_approve_time_2 = ".mktime()." WHERE step4_id = ".$result['step4_id'];				$this->db->query($sql);								//添加日志 --- START				$logarr = array('log_type'=>'step_4_2', 'product_id'=>$product_id, 'target_id'=>$step4_id, 'created'=>mktime());				$this->db->insert(DB_PRE().'product_log', $logarr);				//添加日志 --- END			}		}else{			$this->db->insert(DB_PRE().'product_step4', array('isdel'=>0, 'product_id'=>$product_id, 'step4_status_num'=>1, 'step4_approve_status'=>0, 'step4_approve_time_1'=>mktime(), 'created'=>mktime(), 'edited'=>mktime()));			$step4_id = $this->db->insert_id();			//添加日志 --- START				$logarr = array('log_type'=>'step_4_1', 'product_id'=>$product_id, 'target_id'=>$step4_id, 'created'=>mktime());				$this->db->insert(DB_PRE().'product_log', $logarr);			//添加日志 --- END		}	}		function tosubmitproduct_step5($product_id = 0){		$sql = "SELECT * FROM ".DB_PRE()."product_step5 WHERE product_id = ".$product_id;		$result = $this->db->query($sql)->row_array();		if(!empty($result)){			$step5_id = $result['step5_id'];			$this->db->update(DB_PRE().'product_step5', array('product_id'=>$product_id, 'step5_approve_status'=>1, 'step5_approve_time'=>mktime(), 'created'=>mktime(), 'edited'=>mktime()), array('step5_id'=>$result['step5_id']));			//添加日志 --- START				$logarr = array('log_type'=>'step_5_1', 'product_id'=>$product_id, 'target_id'=>$step5_id, 'created'=>mktime());				$this->db->insert(DB_PRE().'product_log', $logarr);			//添加日志 --- END		}else{			$this->db->insert(DB_PRE().'product_step5', array('product_id'=>$product_id, 'step5_approve_status'=>1, 'step5_approve_time'=>mktime(), 'created'=>mktime(), 'edited'=>mktime()));			$step5_id = $this->db->insert_id();			//添加日志 --- START				$logarr = array('log_type'=>'step_5_1', 'product_id'=>$product_id, 'target_id'=>$step5_id, 'created'=>mktime());				$this->db->insert(DB_PRE().'product_log', $logarr);			//添加日志 --- END		}	}		function tosubmitproduct_step5_2($product_id = 0){		$sql = "SELECT * FROM ".DB_PRE()."product_step4 WHERE product_id = ".$product_id." AND isdel = 0";		$result = $this->db->query($sql)->row_array();		if(!empty($result)){			$this->db->update(DB_PRE().'product_step4', array('isdel'=>1, 'isdel_time'=>mktime()), array('step4_id'=>$result['step4_id']));			//添加日志 --- START				$logarr = array('log_type'=>'step_5_2', 'product_id'=>$product_id, 'target_id'=>0, 'created'=>mktime());				$this->db->insert(DB_PRE().'product_log', $logarr);			//添加日志 --- END		}									}		}/* End of file welcome.php *//* Location: ./application/controllers/welcome.php */